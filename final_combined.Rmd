---
title: "Final Project"
author: "Gamze Bilsen, Sierra Cheung, Sehrish Mastoor"
date: "4/30/2022"
output:
  html_document:
    toc: true
    toc_depth: 6
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(devtools)
library(dbplyr)
library(dplyr)
library(DT)
library(forcats)
library(geojsonsf)
library(geometries)
library(geospatial)
library(ggalt)   
library(ggmap)
library(ggplot2)
library(ggpubr)
library(ggrepel)
library(ggthemes)
library(htmlwidgets)
library(leaflet)
library(maps)
library(magrittr)
library(paletteer)
library(plotly)
library(raster)
library(RColorBrewer)
library(readr)
library(rgdal)
library(rnaturalearth)
library(rnaturalearthdata)
library(rvest)
library(scales)
library(sf)
library(sp)
library(stringr)
library(tidymodels)
library(tidyr)
library(tidytext)
library(tidyverse)
library(tmap)

vignette(package = "tmap") # available vignettes in tmap
vignette("tmap-nutshell")

devtools::install_github("rstudio/leaflet")
```
```{r}
finaldata <- read_csv('final_to_use.csv')
df<- read_csv("final_to_use.csv")

#Changing column names ahead of time to match everyone's code
colnames(df)[5] <- 'Total.Deaths'
colnames(df)[6] <- 'Total.Affected'
colnames(df)[68] <- 'perc.Final.Energy.from.Renewables'
colnames(df)[69] <- 'Urban.Population'
colnames(df)[74] <- 'Food.Production'
colnames(df)[82] <- 'Life.Expectancy'

colnames(finaldata)[42] <- 'Arable.Land'
colnames(finaldata)[82] <- 'Life.Expectancy'
```

# Climate Indicators

## Temperatures and CO2 emissions in 2015 
```{r}
## Mean temperature correlation with CO2 emissions for the year 2015 
df1 <- df %>%
    filter(Year == "2015") %>%
    group_by(Country, tmean, co2_emission) %>% 
    summarize(co2_emission) %>%
    arrange(desc(co2_emission)) %>%
    ungroup() %>%
    slice(1:15)

## Max temperature correlation with CO2 emissions for the year 2015 
df1max <- df %>%
    filter(Year == "2015") %>%
    group_by(Country, tmax, co2_emission) %>% 
    summarize(co2_emission) %>%
    arrange(desc(co2_emission)) %>%
    ungroup() %>%
    slice(1:15)
  
  
## Mean temperature correlation with N.o emissions for the year 2015 
df2 <- df %>%
    filter(Year == "2015") %>%
    group_by(Country, tmean, nitrousoxide_emissions) %>% 
    summarize(nitrousoxide_emissions) %>%
    arrange(desc(nitrousoxide_emissions)) %>%
    ungroup() %>%
    slice(1:15)

## Max temperature correlation with N.o emissions for the year 2015 
df2max <- df %>%
    filter(Year == "2015") %>%
    group_by(Country, tmax, nitrousoxide_emissions) %>% 
    summarize(nitrousoxide_emissions) %>%
    arrange(desc(nitrousoxide_emissions)) %>%
    ungroup() %>%
    slice(1:15)

#Countries with the highest temperature
tempc02 <- 
  ggplot(df1 , aes(fill = Country, x = tmean, y = co2_emission, 
)) + geom_point(alpha=0.5, size=3)+
labs(x ="Mean Temperatue", y ="Co2 Emissions", 
                        title = "15 Countries with the highest Co2 Emissions with Mean Temperature")
ggplotly(tempc02)

tempmaxc02 <- 
  ggplot(df1max , aes(fill = Country, x = tmax, y =co2_emission, 
)) + geom_point(alpha=0.5, size=3)+
labs(x ="Max Temperatue", y ="Co2 Emissions", 
                        title = "15 Countries with the highest Co2 Emissions with Max Temperature") 
ggplotly(tempmaxc02)

```

## Mean and Max Temperatures and Nitrous Oxide
```{r}
tempNo2 <- 
  ggplot(df2 , aes(fill = Country, x = tmean, y = nitrousoxide_emissions/1000000, 
)) + geom_point(alpha=0.5, size=4)+
labs(x ="Mean Temperatue", y ="Nitrous Oxide Emissions", 
                        title = "Highest Nitrous Oxide Emissions with Mean Temperature") 
ggplotly(tempNo2)

tempmaxNo2 <- 
  ggplot(df2max , aes(fill = Country, x = tmax, y = nitrousoxide_emissions/1000000, 
)) + geom_point(alpha=0.5, size=4)+
labs(x ="Max Temperatue", y ="Nitrous Oxide Emissions", 
                      title = "Highest Nitrous Oxide Emissions with Max Temperature") 
ggplotly(tempmaxNo2)
```
## Changes throughout time

Decrease in weather related disasters: https://www.nationalgeographic.com/environment/article/weather-disaster-related-deaths-are-downwarming-could-undo-that-trend

```{r}
year <- df %>% 
  group_by(Year) %>%
  summarize(sum_death = sum(Total.Deaths,na.rm=TRUE),
            sum_affected = sum(Total.Affected, na.rm=TRUE),
            affected_to_death = sum(Total.Deaths/Total.Affected,na.rm=TRUE),
            average_temp = mean(tmean,na.rm=TRUE),
            average_max_temp = mean(tmax,na.rm=TRUE),
            average_min_temp = mean(tmin,na.rm=TRUE),
            sum_freq = sum(Frequency,na.rm=TRUE),
            avg_gdp_cap_growth = mean(gdp_per_cap_growth, na.rm=TRUE),
            sum_no2 = sum(nitrousoxide_emissions,na.rm=TRUE)/1000000,
            sum_co2 = sum(co2_emission,na.rm=TRUE)/1000000)
ggplot(year, aes(x=Year)) +
  geom_line(aes(y=average_temp)) +
  geom_line(aes(y=sum_co2)) +
  geom_line(aes(y=average_max_temp),color='red') +
  geom_line(aes(y=average_min_temp),color='blue') + 
  xlim(1980,2015) +
  scale_y_continuous(name = "Temperature",
    sec.axis = sec_axis( trans=~.*1000000, name="CO2 Emissions"))
  
```

# Climate Disasters

```{r}

df1 <- df[, c('Country', 'Year', 'gdp_per_cap', 'Total.Deaths','Frequency')]

x <- df1 %>%
  filter(Year>=2010 , Year <=2015) %>%
  group_by(Year) %>%
  summarize(totaldeathcount = sum(Total.Deaths, na.rm=TRUE),
            totalfrequency = sum(Frequency, na.rm=TRUE),
            avggdp = mean(gdp_per_cap, na.rm=TRUE)
            )

```

## Countries affected most by climate related disasters based on total number of deaths from 2010 to 2015
```{r}
require(gridExtra)
death <- df %>%
  filter(Year>=2010&Year<=2015) %>%
    group_by(Country,Year) %>%
    summarize(total_deaths =sum(Total.Deaths,na.rm=TRUE)) %>%
    arrange(desc(total_deaths))

```

## Total amount of disasters and total deaths throughout the last 20 years
```{r}
death <- df %>%
  filter(Year>=2010&Year<=2015) %>%
    group_by(Country,Year) %>%
    summarize(total_deaths =sum(Total.Deaths,na.rm=TRUE)) %>%
    arrange(desc(total_deaths))
death
```

#### Need to ask Gamze if there's extra code here
plot1 <- ggplot(ten, aes(y=total_deaths, x=reorder(Country, desc(total_deaths), fill = Country, color_continuous_scale=scale))) + 
  geom_col() + coord_flip() +xlab('Countries') +ylab(' ') +
  theme(axis.title.x = element_text(size = 10),
        axis.title.y = element_text(size=10))
        
        
plot2 <- ggplot(eleven, aes(y=total_deaths, x=reorder(Country, desc(total_deaths), fill = Country, color_continuous_scale=scale))) + 
  geom_col() + coord_flip() +xlab(' ') +ylab(' ')
  
  
plot3 <- ggplot(twelve, aes(y=total_deaths, x=reorder(Country, desc(total_deaths), fill = Country, color_continuous_scale=scale))) + 
  geom_col() + coord_flip() +xlab(' ') +ylab(' ')
  
  
plot4 <- ggplot(thirt, aes(y=total_deaths, x=reorder(Country, desc(total_deaths), fill = Country, color_continuous_scale=scale))) + 
  geom_col() + coord_flip() +xlab('Countries') +ylab('Total Deaths') +
  theme(axis.title.x = element_text(size = 10),
        axis.title.y = element_text(size=10))
        
        
plot5 <- ggplot(fourt, aes(y=total_deaths, x=reorder(Country, desc(total_deaths), fill = Country, color_continuous_scale=scale))) + 
  geom_col() + coord_flip() +xlab(' ') +ylab('Total Deaths') +
  theme(axis.title.x = element_text(size = 10),
        axis.title.y = element_text(size=10))
        
        
plot6 <- ggplot(five, aes(y=total_deaths, x=reorder(Country, desc(total_deaths), fill = Country, color_continuous_scale=scale))) + 
  geom_col() + coord_flip() +xlab(' ') +ylab('Total Deaths') +
  theme(axis.title.x = element_text(size = 10),
        axis.title.y = element_text(size=10))

grid.arrange(plot1, plot2, plot3,plot4,plot5,plot6, ncol=3,nrow=2, 
             top='Top 10 Climate Disasters by Total Number of Deaths per Year') 

#Mapping
## Country Specs
```{r}
countryfinal <- df %>% 
  filter(Year>=2010&Year<=2015)%>%
  group_by(Country) %>%
  summarize(sum_death = sum(Total.Deaths,na.rm=TRUE),
            sum_affected = sum(Total.Affected, na.rm=TRUE),
            affected_to_death = sum(Total.Deaths/Total.Affected,na.rm=TRUE),
            average_temp = mean(tmean,na.rm=TRUE),
            sum_freq = sum(Frequency,na.rm=TRUE),
            avg_gdp_cap_growth = mean(gdp_per_cap_growth, na.rm=TRUE),
            average_perc_urban = mean(Urban.Population, na.rm=TRUE),
            avg_gdp = mean(GDP),
            avg_gdp_cap = mean(gdp_per_cap,na.rm=TRUE),
            avg_temp = mean(tmean,na.rm=TRUE),
            average_perc_arable = mean(perc_arable_land_area, na.rm=TRUE),
            average_food_prod = mean(Food.Production, na.rm=TRUE),
            average_pop = mean(Population,na.rm=TRUE),
            avg_life_exp = mean(Life.Expectancy,na.rm=TRUE),
            avg_perc_forest = mean(perc_forest_land_area,na.rm=TRUE),
            avg_perc_energy_ren = mean(perc.Final.Energy.from.Renewables,na.rm=TRUE),
            avg_co2 = mean(co2_emission,na.rm=TRUE),
            avg_remittances = mean(remittances_received,na.rm=TRUE),
            avg_elect_days = mean(days_for_electricity,na.rm=TRUE),
            average_max_temp = mean(tmax,na.rm=TRUE),
            average_min_temp = mean(tmin,na.rm=TRUE))

world <- ne_countries(scale = "medium", returnclass = "sf")
world_map <- merge(world, countryfinal, by.x="name", by.y="Country")

population_data<-na.omit(df[,c('Country','Year','Population')])%>% 
  group_by(Country) %>%
  slice(which.max(Year))

world_map <- merge(world_map,population_data,by.x='name',by.y='Country')

labels <- paste(
  "<strong>",world_map$name,"</strong><br/>Average Temperature",round(world_map$avg_temp,2),"C",
  "<br/>Maximum Temperature",round(world_map$average_max_temp,2), "C",
  "<br/>Minimum Temperature",round(world_map$average_min_temp,2), "C",
  "<br/>Total Deaths from Disasters",round(world_map$sum_freq,2)
) %>% lapply(htmltools::HTML)

leaflet(world_map)%>%
 addPolygons(stroke = TRUE, smoothFactor = 0.5,
  weight=1, color='#333333', opacity=1, 
  fillColor = ~colorQuantile("Greens", avg_temp)(avg_temp), 
  fillOpacity = 1,
  highlightOptions = highlightOptions(
    weight = 3,
    fillOpacity = 0.7,
    bringToFront = TRUE),
  popup = labels)
```


## CO2 Emitter Rankings Worldwide

Comparison of Highest and Lowest Co2 Emitting Countries +  life expectancy + GDP worldwide (on a map)
```{r}
top10co2 <- filter(finaldata, Year ==2015)%>%
  group_by(Year, Country, co2_emission, Life.Expectancy, GDP)%>%
  summarize(count_co2=co2_emission, count_life=Life.Expectancy, count_gdp =GDP) %>%
  arrange(desc(co2_emission))%>%
  ungroup()%>%
  slice(1:10)

bottom10co2 <- filter(finaldata, Year ==2015)%>%
  group_by(Year, Country, co2_emission, Life.Expectancy, GDP)%>%
  summarize(count_co2=co2_emission, count_life=Life.Expectancy, count_gdp =GDP) %>%
  arrange(desc(-co2_emission))%>%
  ungroup()%>%
  slice(1:10)

top10co2['rank'] <- 'Top 10 Emitter'
bottom10co2['rank'] <- 'Bottom 10 Emitter'


#binding top and bottom 10 co2 level countries
top10_bottom10 <- rbind(top10co2, bottom10co2)

#Longitude and latitudes for top and bottom 10 countries
longitude <- c(116.20, #China
               -77.02, #US
               77.13, #India
               138.25, #Japan
               13.25, #Germany
               45.00, #Saudi Arabia
               -106.42, #Canada
               113.10, #Indonesia
               -51.92, #Brazil
               -102.55, #Mexico
               177.65, #tuvalu
               166.3, #Nauru
               -168.73, #Kiribati
               -175.20, #Tonga
               6.61, #Sao Tome and Principe
               173, #Vanuatu
               -171.00, #Marshall Islands
               43.33, #Comoros
               9.55, #Liechtenstein
               -61.37) #Dominica

latitude <- c(39.55, #China
              39.91, #US
              28.37, #India
              36.20, #Japan
              52.30, #Germany
              23.88, #saudi Arabia
              56.27, #Canada 
              -6.09, #Indonesia
              -14.47, #Brazil
              23.63, #Mexico
              -7.10, #tuvalu
              -0.523, #Nauru
              -3.37, #Kiribati
              -21.10, #Tonga
              0.16, #Sao Tome and Principe
              -17.45, #Vanuatu
              7.13, #Marshall Islands
              -11.64, #Comoros
              47.08, #Liechtenstein
              15.41) #Dominica

top10_bottom10['longitude'] <- longitude
top10_bottom10['latitude'] <- latitude

#adding pop-up contents
popup_content <- paste("Country:",top10_bottom10$Country,"<br/>",
                       "CO2 Emissions (Hundred Thou. KT):",(top10_bottom10$co2_emission)*1000,"<br/>",
                       "2015 Life Expetancy (Years):",round(top10_bottom10$Life.Expectancy, digits = 3),"<br/>",
                       "2015 GDP (in Billions):",top10_bottom10$GDP,"<br/>")
#assigning colors to countries
pal = colorFactor("Set2", domain = top10_bottom10$rank)
color_avail = pal(top10_bottom10$rank)

#plotting on world map
leaflet(top10_bottom10) %>%
  addTiles() %>%
  addCircleMarkers(lng = ~longitude, lat = ~latitude, group = "Country",
                   fillColor=color_avail, stroke = TRUE, fillOpacity = 1, popup = popup_content)%>%
  addLegend(pal = pal, values = ~top10_bottom10$rank, title = "CO2 Emitters")
```

# GHG Emissions
## Carbon dioxide Emissions from 2010 till 2015
```{r}
# Countries with the total highest Co2 Emissions from 2010 to 2015 
co2 <- df %>%
    filter(Year>="2010" , Year <="2015") %>%
    group_by(Year, Country, co2_emission)

totalco2 <- co2 %>% 
    group_by(Year,Country, co2_emission) %>%
    group_by(Country) %>%
    summarize(Count = sum(co2_emission)) %>% 
    arrange(desc(Count)) %>%
    ungroup() %>%
    slice(1:10)

plotco2 <- ggplot(totalco2 , aes(y=Count, x=reorder(Country, desc(Count)))) +  geom_bar(stat="identity") +
    labs(x = "Countries", y = "Carbon dioxide levels", 
       title = "Countries Carbon dioxide Emissions from 2010 till 2015")
ggplotly(plotco2)

p <- ggplot(totalco2 , aes(x=Count, y=reorder(Country,Count), fill = Country)) + geom_point(alpha=0.5,size=3) +  labs(x = "Carbon dioxide levels", y = "Countries", 
       title = "Countries Carbon dioxide Emissions from 2010 till 2015") +  theme(legend.position="none")
ggplotly(p)
```
## Country Wellbeing Plots

### Arable Land for Top and Bottom 10 CO2 Emitters
```{r}
dataco2 <- filter(finaldata, is.na('co2_emission') == FALSE)%>%
  filter(Year > 2009, Year < 2016)%>%
  group_by(Year, Country, co2_emission)

dataco2 <- filter(finaldata, Year == 2015)%>%
  group_by(Country, co2_emission, Arable.Land) %>%
  summarize(count_co2=co2_emission, count_ar=Arable.Land) %>%
  arrange(desc(co2_emission))%>%
  ungroup()%>%
  slice(1:10)

#plotting co2 and arable land
plot1 <- ggplot(dataco2, aes(x= count_co2, y= count_ar, 
                              color = Country)) + 
  geom_point(position="dodge", stat="identity", 
             width = 1, alpha = 0.7, size = 4) +
  xlab('Average CO2 Emissions (Millions of Kilotons)') + ylab('Average Arable Land') + 
  ggtitle("Average Arable Land and CO2 Emissions from 2010-2015")
ggplotly(plot1)
```

### Economic and Population Wellbeing and CO2 Emissions
Co2 emissions + GDP (how top 10 and bottom 10 GDP countries compare in CO2 emissions from 2010-2015)

Below is a plot of the top and bottom CO2 Emitters worldwide. 
```{r}
library(plotly)
plot3 <- plot_ly(top10_bottom10, x = ~Country, y = ~Life.Expectancy, 
                 type = 'bar', color = ~rank)
plot3
```

### GDP of countries Worldwide in 2020
```{r}
## GDP for the year 2020 
gdp <- df %>%
  filter(Year == "2015") %>%
    group_by(Country, GDP) %>%
    summarize(count=GDP) %>%
    arrange(desc(GDP))

# Top 10 Countries according to GDP
top10gdp <-gdp %>% 
ungroup() %>%
slice(1:10)

top10gdp$finalcount <- top10gdp$count / 1000000000

plot <- ggplot(top10gdp, aes(y=finalcount, x=reorder(Country, desc(finalcount), fill = Country, color_continuous_scale=scale))) + 
  geom_col() +
  coord_flip() + 
    labs(x = "Countries", y = "GDP in billions dollars", 
       title = "Top 10 Countries according to GDP: 2015")
ggplotly(plot)
```

### Deaths in Countries Worldwide in 2020
```{r}
## Total deaths for the year 2020 
death <- df %>%
  filter(Year == "2015") %>%
    group_by(Country, Total.Deaths) %>%
    summarize(count = Total.Deaths) %>%
    arrange(desc(Total.Deaths))

# Top 10 Countries according to death 
topdeath <-death %>% 
ungroup() %>%
slice(1:10)

plot <- ggplot(topdeath, aes(y=count, x=reorder(Country, desc(count)))) + 
  geom_col() +
  coord_flip() + 
    labs(x = "Countries", y = "Total Deaths", 
       title = "Top 10 Countries according to Total Deaths: 2015") +  scale_colour_brewer(palette = "Set1")
ggplotly(plot)
```

### GDP/capita & Total Death Frequency
```{r}
# GDP percapita with total deaths Frequency 

df1 <- df[, c('Country', 'Year', 'gdp_per_cap', 'Total.Deaths','Frequency','tmean')]

x <- df1 %>%
  filter(Year>=2010 , Year <=2015) %>%
  #group_by(gdp_per_cap, Total Deaths,Frequency) %>% 
  group_by(Country) %>%
  summarize('Total.Death.Count' = sum(`Total.Deaths`, na.rm=TRUE),
            'Total Frequency' = sum(Frequency, na.rm=TRUE),
            'Average GDP' = mean(gdp_per_cap, na.rm=TRUE),
            'Average Temperature' = mean(tmean,na.rm=TRUE)
            )
x
```










